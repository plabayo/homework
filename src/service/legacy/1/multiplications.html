<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>rekendoos maaltafels</title>

  <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%2210 0 100 100%22><text y=%22.90em%22 font-size=%2290%22>‚úñÔ∏è</text></svg>">

  <meta property="og:title" content="rekendoos maaltafels" />
  <meta property="og:locale" content="nl_BE" />
  <meta property="og:type" content="website">
  <meta property="og:description" content="gratis huiswerk middel voor maaltafels te oefenen" />
  <meta property="og:site_name" content="rekendoos" />

  <link rel="stylesheet" href="/css/reset.css">

  <style>
    body { padding-inline: 10px; }
    main { max-width: 800px; margin-inline: auto; }
    h1 { text-align: center; }
    button:disabled { opacity: 0.5; }
    #exercise-meta { margin: 0 auto; width: fit-content; }
    form { padding: 5px; }
    #form-setup > * { margin-block-end: 10px; }
    #form-exercise { display: flex; flex-direction: column; align-items: center; }
    #form-exercise span, #form-exercise input, #form-exercise button, .exercise-feedback span {
      margin: 5px; font-size: 2em;
    }
    .box { border: 1px solid black; padding: 10px; margin: 10px; width: fit-content; border-radius: 5px; }
    .exercise-feedback { display: flex; flex-direction: column; align-items: center; margin: 10px auto; }
    .exercise-feedback > h3 { margin-block-end: 5px; }
    #exercise { margin: 20px auto; }
    #exercise-feedback { text-align: center; margin-block: 5px; }
    span.split-part { width: 3em; display: inline-block; text-align: center; }
    input.split-part { text-align: center; line-height: 2em; border: 1px solid black; border-radius: 5px; }
    #answer { width: 3em; padding-inline-start: 0.25em; }
    #exercise, #answer { background-color: #fffde6 }
    #result { margin: 20px auto; text-align: center; }
    #confetti { overflow-y: hidden; overflow-x: hidden; width: 100vw; margin: 0; height: 100vh; position: absolute; top: 0; z-index: -1; }
    .bad { background-color: rgb(253, 220, 220); }
    #review-buttons { margin-block: 10px; }

    /* tafelkeuze */
    #tables { display: flex; flex-wrap: wrap; gap: 10px; max-width: 420px; }
    #tables label { display: inline-flex; align-items: center; gap: 6px; }
    #tables-all { margin-block-start: 8px; }
  </style>
</head>
<body>
  <main>
    <h1>maaltafels <code>‚úñÔ∏è</code></h1>
    <p><a href="/">üè† Ga terug naar de thuispagina.</a></p>

    <div id="page-setup">
      <p>Oefen hier de maaltafels. Kies hoeveel oefeningen en welke tafels.</p>

      <form id="form-setup" action="javascript:void(0)">
        <label for="num-exercises">Hoeveel oefeningen wil je doen</label><br/>
        <input inputmode="numeric" pattern="[0-9]+" id="num-exercises" name="num-exercises" min="1" max="200" value="10" required><br/>

        <div>
          <strong>Welke maaltafels</strong>
          <div id="tables"></div>
          <div id="tables-all">
            <input type="checkbox" id="select-all" />
            <label for="select-all">Selecteer alle tafels van 1 tot en met 10</label>
          </div>
        </div>

        <button type="submit">üü¢ start met oefenen</button>
      </form>
    </div>

    <div id="page-exercises" hidden>
      <button class="button-reset">begin opnieuw ‚Ü©Ô∏è</button>
      <div id="exercise-meta">
        <p id="form-title"></p>
      </div>
      <div id="exercise" class="box">
        <h3 id="exercise-feedback">&nbsp;</h3>
        <form id="form-exercise" action="javascript:void(0)"></form>
      </div>
    </div>

    <div id="page-result" hidden>
      <canvas id="confetti"></canvas>
      <button class="button-reset">begin opnieuw ‚Ü©Ô∏è</button>
      <div id="result"></div>
    </div>

    <script>
      window.onload = () => {
        console.log("rekendoos maaltafels loaded");

        function randomAnimal() {
          const animals = ['üê∂','ü¶ä','ü¶Ñ','üê≠','üêº','üê£','ü¶â'];
          return animals[Math.floor(Math.random() * animals.length)];
        }

        function shuffle(array) {
          let currentIndex = array.length;
        
          // While there remain elements to shuffle...
          while (currentIndex != 0) {
        
            // Pick a remaining element...
            let randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
        
            // And swap it with the current element.
            [array[currentIndex], array[randomIndex]] = [
              array[randomIndex], array[currentIndex]];
          }
        }

        // Bouw een deck met alle combinaties van gekozen tafels maal 1..10
        function buildDeck(tables) {
          const deck = [];
          for (const t of tables) {
            for (let f = 1; f <= 10; f++) {
              deck.push({
                exercise: "vermenigvuldigen",
                a: t,
                b: f,
                answer: t * f
              });
            }
          }
          shuffle(deck);
          return deck;
        }

        window.tablesState = {
          numExercises: 10,
          exerciseCount: 0,
          wrongExerciseCount: 0,
          selectedTables: [],
          exercise: {},
          wrongExercises: [],
          premadeExercises: [],
          deck: []          // hier bewaren we de nog niet gebruikte oefeningen
        };

        function renderTableChoices() {
          const wrap = document.getElementById("tables");
          wrap.innerHTML = "";
          for (let t = 1; t <= 10; t++) {
            const id = "table-" + t;
            const box = document.createElement("div");
            box.innerHTML = `
              <input type="checkbox" id="${id}" data-table="${t}" />
              <label for="${id}">tafel ${t}</label>
            `;
            wrap.appendChild(box);
          }

          // Restore
          try {
            const stored = JSON.parse(localStorage.getItem("tablesConfig"));
            if (stored) {
              if (stored.numExercises) document.getElementById("num-exercises").value = stored.numExercises;
              if (Array.isArray(stored.selectedTables) && stored.selectedTables.length > 0) {
                stored.selectedTables.forEach(t => {
                  const el = document.querySelector(`input[data-table="${t}"]`);
                  if (el) el.checked = true;
                });
              }
            }
          } catch(e) {}

          syncSelectAllFromBoxes();
        }

        function getSelectedTables() {
          const list = [];
          document.querySelectorAll('#tables input[type="checkbox"]').forEach(cb => {
            if (cb.checked) list.push(Number(cb.dataset.table));
          });
          return list.sort((a,b) => a - b);
        }

        function syncSelectAllFromBoxes() {
          const all = document.getElementById("select-all");
          const boxes = Array.from(document.querySelectorAll('#tables input[type="checkbox"]'));
          const allChecked = boxes.length > 0 && boxes.every(cb => cb.checked);
          all.checked = allChecked;
        }

        function setAllBoxes(checked) {
          document.querySelectorAll('#tables input[type="checkbox"]').forEach(cb => cb.checked = checked);
        }

        function showSetup() {
          document.getElementById("page-setup").hidden = false;
          document.getElementById("page-exercises").hidden = true;
          document.getElementById("page-result").hidden = true;
        }
        function showExercises() {
          document.getElementById("page-setup").hidden = true;
          document.getElementById("page-exercises").hidden = false;
          document.getElementById("page-result").hidden = true;
        }
        function showResult() {
          document.getElementById("page-setup").hidden = true;
          document.getElementById("page-exercises").hidden = true;
          document.getElementById("page-result").hidden = false;
        }

        renderTableChoices();
        showSetup();

        document.querySelectorAll(".button-reset").forEach(btn => {
          btn.addEventListener("click", e => {
            e.preventDefault();
            showSetup();
          });
        });

        document.getElementById("select-all").addEventListener("change", e => {
          setAllBoxes(e.target.checked);
        });
        document.getElementById("tables").addEventListener("change", e => {
          if (e.target.matches('input[type="checkbox"]')) {
            syncSelectAllFromBoxes();
          }
        });

        function trackWrongExercise() {
          const last = tablesState.wrongExercises.length > 0
            ? JSON.stringify(tablesState.wrongExercises[tablesState.wrongExercises.length - 1])
            : null;
          const current = JSON.stringify(tablesState.exercise);
          if (last !== current) {
            tablesState.wrongExerciseCount += 1;
            tablesState.wrongExercises.push(JSON.parse(current));
            const skipButton = document.getElementById("button-skip");
            if (skipButton) skipButton.hidden = false;
          }
        }

        function drawFromDeck() {
          // Vul aan als deck leeg is
          if (!tablesState.deck || tablesState.deck.length === 0) {
            tablesState.deck = buildDeck(tablesState.selectedTables);
          }
          // Neem de laatste kaart en geef terug
          return tablesState.deck.pop();
        }

        function nextExercise() {
          if (tablesState.exerciseCount < tablesState.numExercises) {
            generateExercise();
          } else {
            // klaar
            showResult();

            const score = tablesState.exerciseCount - tablesState.wrongExerciseCount;
            const total = tablesState.exerciseCount;
            document.getElementById("confetti").style.height = score === total ? '100vh' : '0';

            const feedback = document.getElementById("result");
            feedback.innerHTML = `<h2>üéâ klaar</h2>`;
            feedback.innerHTML += `<h3>${score} &sol; ${total}</h3>`;

            if (tablesState.wrongExercises.length > 0) {
              const animal = randomAnimal();
              feedback.innerHTML += `<h2>${animal} bekijk goed</h2>`;
              feedback.innerHTML += `
                <div id="review-buttons">
                  <button id="review-button-repeat">üü¢ herhaal</button>
                </div>
                <div id="review-buttons">
                  <button id="review-button-back">‚¨ÖÔ∏è vorige</button>
                  <button id="review-button-next">volgende ‚û°Ô∏è</button>
                </div>
                <div id="review"></div>
              `;

              let index = 0;

              function setReviewButtons() {
                document.getElementById("review-button-back").disabled = index === 0;
                document.getElementById("review-button-next").disabled = index === tablesState.wrongExercises.length - 1;
              }

              document.getElementById("review-button-repeat").addEventListener("click", e => {
                e.preventDefault();
                tablesState.numExercises = tablesState.wrongExercises.length;
                tablesState.exerciseCount = 0;
                tablesState.wrongExerciseCount = 0;
                tablesState.premadeExercises = tablesState.wrongExercises;
                tablesState.wrongExercises = [];
                showExercises();
                generateExercise();
              });

              document.getElementById("review-button-back").addEventListener("click", e => {
                e.preventDefault();
                if (index === 0) return;
                index -= 1;
                displayExercise();
                setReviewButtons();
              });

              document.getElementById("review-button-next").addEventListener("click", e => {
                e.preventDefault();
                if (index === tablesState.wrongExercises.length - 1) return;
                index += 1;
                displayExercise();
                setReviewButtons();
              });

              function displayExercise() {
                const ex = tablesState.wrongExercises[index];
                let html = '<div class="box exercise-feedback">';
                html += "<h3>maak de vermenigvuldiging ‚úñÔ∏è</h3>";
                html += `
                  <p>
                    <span>${ex.a} x ${ex.b} = </span>
                    <span class="box bad split-part">${ex.answer}</span>
                  </p>
                `;
                html += '</div>';
                document.getElementById("review").innerHTML = html;
              }
              displayExercise();
              setReviewButtons();
            }
          }
        }

        function generateExercise() {
          tablesState.exerciseCount += 1;
          document.getElementById("exercise-feedback").innerHTML = "&nbsp;";

          if (tablesState.premadeExercises.length > 0) {
            const i = Math.floor(Math.random() * tablesState.premadeExercises.length);
            tablesState.exercise = tablesState.premadeExercises.splice(i, 1)[0];
          } else {
            // trek zonder herhaling tot deck op is
            tablesState.exercise = drawFromDeck();
          }

          document.getElementById("form-title").innerHTML =
            `oefening ${tablesState.exerciseCount} van ${tablesState.numExercises}`;

          document.getElementById("exercise-feedback").innerHTML = "maak de vermenigvuldiging ‚úñÔ∏è";
          document.getElementById("form-exercise").innerHTML = `
            <p>
              <span>${tablesState.exercise.a} x ${tablesState.exercise.b} =</span>
              <input inputmode="numeric" pattern="[0-9]+" id="answer" name="answer" min="0" max="1000" value="" required>
            </p>
            <button type="submit" id="button-check">üëâ antwoord</button>
            <button type="reset" id="button-skip" hidden>ü§∑ weet het niet</button>
          `;

          const answerEl = document.getElementById("answer");
          answerEl.style.backgroundColor = "#fffde6";
          document.getElementById("exercise-feedback").style.color = "black";
          answerEl.focus();
          answerEl.click();

          document.getElementById("button-skip").addEventListener("click", e => {
            e.preventDefault();
            trackWrongExercise();
            nextExercise();
          });

          document.getElementById("exercise").scrollTo({ behavior: "smooth" });
        }

        function validateAnswer() {
          const answer = Number(document.getElementById("answer").value);
          if (answer == tablesState.exercise.answer) {
            nextExercise();
          } else {
            const animal = randomAnimal();
            document.getElementById("exercise-feedback").innerHTML = `${animal} Probeer het nog eens.`;
            document.getElementById("exercise-feedback").style.color = "red";
            document.getElementById("answer").style.backgroundColor = "rgb(253, 220, 220)";
            trackWrongExercise();
          }
        }

        document.getElementById("form-setup").addEventListener("submit", e => {
          e.preventDefault();

          const numExercises = Number(document.getElementById("num-exercises").value);
          const selectedTables = getSelectedTables();

          if (selectedTables.length === 0) {
            alert("Gelieve minstens √©√©n maaltafel te selecteren.");
            return;
          }

          tablesState.numExercises = numExercises;
          tablesState.selectedTables = selectedTables;
          tablesState.exerciseCount = 0;
          tablesState.wrongExerciseCount = 0;
          tablesState.exercise = {};
          tablesState.wrongExercises = [];
          tablesState.premadeExercises = [];
          tablesState.deck = buildDeck(tablesState.selectedTables);

          localStorage.setItem("tablesConfig", JSON.stringify({
            numExercises: tablesState.numExercises,
            selectedTables: tablesState.selectedTables
          }));

          showExercises();
          generateExercise();
        });

        document.getElementById("form-exercise").addEventListener("submit", e => {
          e.preventDefault();
          validateAnswer();
        });

        // confetti
        (() => {
          let W = window.innerWidth;
          let H = window.innerHeight;
          const canvas = document.getElementById('confetti');
          const context = canvas.getContext("2d");
          const maxConfettis = 25;
          const particles = [];

          const possibleColors = ["#ff7336","#f9e038","#02cca4","#383082","#fed3f5","#b1245a","#f2733f"];

          function randomFromTo(from, to) {
            return Math.floor(Math.random() * (to - from + 1) + from);
          }

          function confettiParticle() {
            this.x = Math.random() * W;
            this.y = Math.random() * H - H;
            this.r = randomFromTo(11, 33);
            this.d = Math.random() * maxConfettis + 11;
            this.color = possibleColors[Math.floor(Math.random() * possibleColors.length)];
            this.tilt = Math.floor(Math.random() * 33) - 11;
            this.tiltAngleIncremental = Math.random() * 0.07 + 0.05;
            this.tiltAngle = 0;

            this.draw = function () {
              context.beginPath();
              context.lineWidth = this.r / 2;
              context.strokeStyle = this.color;
              context.moveTo(this.x + this.tilt + this.r / 3, this.y);
              context.lineTo(this.x + this.tilt, this.y + this.tilt + this.r / 5);
              return context.stroke();
            };
          }

          function Draw() {
            const results = [];
            requestAnimationFrame(Draw);
            context.clearRect(0, 0, W, window.innerHeight);
            for (let i = 0; i < maxConfettis; i++) results.push(particles[i].draw());
            let particle = {};
            for (let i = 0; i < maxConfettis; i++) {
              particle = particles[i];
              particle.tiltAngle += particle.tiltAngleIncremental;
              particle.y += (Math.cos(particle.d) + 3 + particle.r / 2) / 2;
              particle.tilt = Math.sin(particle.tiltAngle - i / 3) * 15;
              if (particle.x > W + 30 || particle.x < -30 || particle.y > H) {
                particle.x = Math.random() * W;
                particle.y = -30;
                particle.tilt = Math.floor(Math.random() * 10) - 20;
              }
            }
            return results;
          }

          window.addEventListener("resize", function () {
            W = window.innerWidth;
            H = window.innerHeight;
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
          }, false);

          for (let i = 0; i < maxConfettis; i++) particles.push(new confettiParticle());
          canvas.width = W;
          canvas.height = H;
          Draw();
        })();
      };
    </script>
  </main>
</body>
</html>
